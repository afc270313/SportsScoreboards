<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Scores Ticker (Seamless Scroll)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
    }
    *, *::before, *::after { box-sizing: border-box; }

    :root {
      --bg: rgba(0, 0, 0, 0.6);
      --fg: #fff;
      --accent: #ffd700;
      --pad: 20px;
      --font: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    #container {
      position: fixed;
      inset: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font);
      font-size: 20px;
      padding: var(--pad);
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }

    #scroll, #scroll-clone {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      will-change: transform;
    }

    .league {
      color: var(--accent);
      font-weight: bold;
      margin-top: 20px;
      word-wrap: break-word;
      white-space: normal;
    }

    .row {
      margin-bottom: 15px;
      text-align: center;
      word-wrap: break-word;
      white-space: normal;
    }

    #status {
      position: absolute;
      bottom: 8px;
      right: 12px;
      opacity: .7;
      font-size: 12px;
      pointer-events: none;
      user-select: none;
    }

    #overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--fg);
      font-size: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      text-align: center;
      padding: 1rem;
    }
  </style>
</head>
<body>

  <div id="container" aria-live="polite">
    <div id="scroll"></div>
    <div id="status"></div>
    <div id="overlay"></div>
  </div>

  <script>
    const API = 'https://sportsscore.afc270313.workers.dev/';
    const REFRESH_MS = 120_000;
    const SPEED_PX_PER_S = 25;

    const container = document.getElementById('container');
    const scrollBox = document.getElementById('scroll');
    const statusEl = document.getElementById('status');
    const overlay = document.getElementById('overlay');

    let rafId = null;
    let isPaused = false;
    let intervalId = null;
    let fetchController = null;
    let prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let inView = true;

    document.addEventListener('visibilitychange', () => {});
    const io = new IntersectionObserver(([entry]) => {
      inView = entry?.isIntersecting ?? true;
    }, { root: null, threshold: 0 });
    io.observe(container);

    container.addEventListener('mouseenter', () => { isPaused = true; });
    container.addEventListener('mouseleave', () => { isPaused = false; });

    function cancelScroll() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      scrollBox.style.transform = 'translateY(0)';
      const oldClone = document.getElementById('scroll-clone');
      if (oldClone) oldClone.remove();
    }

    function renderMatches(matches) {
      const frag = document.createDocumentFragment();
      const byLeague = new Map();

      for (const m of matches) {
        const league = (m.strLeague || 'Other').trim();
        if (!byLeague.has(league)) byLeague.set(league, []);
        byLeague.get(league).push(m);
      }

      const leagues = [...byLeague.keys()].sort((a, b) => a.localeCompare(b));
      for (const league of leagues) {
        const header = document.createElement('div');
        header.className = 'league';
        header.textContent = `üèÜ ${league}`;
        frag.appendChild(header);

        for (const m of byLeague.get(league)) {
          const home = (m.strHomeTeam ?? '').trim() || 'Home';
          const away = (m.strAwayTeam ?? '').trim() || 'Away';
          const hs = (m.intHomeScore ?? '‚Äì');
          const as = (m.intAwayScore ?? '‚Äì');
          const status = (m.strStatus ?? '').trim();
          const progress = (m.strProgress ?? '').trim();

          const row = document.createElement('div');
          row.className = 'row';

          const strong = document.createElement('strong');
          strong.textContent = `${home} ${hs} - ${as} ${away}`;
          row.appendChild(strong);
          row.appendChild(document.createElement('br'));

          const meta = document.createElement('span');
          meta.textContent = (status || progress) ? `${status}${status && progress ? ' ‚Äî ' : ''}${progress}` : '';
          row.appendChild(meta);

          frag.appendChild(row);
        }
      }

      scrollBox.replaceChildren(frag);
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function setOverlay(text = '', show = false) {
      overlay.textContent = text;
      overlay.style.opacity = show ? '1' : '0';
      overlay.style.pointerEvents = show ? 'auto' : 'none';
    }

    function formatTime(d = new Date()) {
      try {
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch {
        return d.toISOString().substring(11, 16);
      }
    }

    function startScroll() {
      cancelScroll();

      const contentH = scrollBox.scrollHeight;
      const containerH = container.clientHeight;

      if (prefersReducedMotion || contentH <= containerH) {
        scrollBox.style.transform = 'translateY(0)';
        return;
      }

      const clone = scrollBox.cloneNode(true);
      clone.id = 'scroll-clone';
      clone.style.top = `${contentH}px`;
      clone.style.position = 'absolute';
      container.appendChild(clone);

      let y = 0;
      const speed = SPEED_PX_PER_S;

      function loop() {
        if (isPaused || document.hidden || !inView) {
          rafId = requestAnimationFrame(loop);
          return;
        }

        y += speed / 60;
        scrollBox.style.transform = `translateY(${-y}px)`;
        clone.style.transform = `translateY(${-y}px)`;

        if (y >= contentH) {
          y = 0;
        }

        rafId = requestAnimationFrame(loop);
      }

      rafId = requestAnimationFrame(loop);
    }

    async function loadScores() {
      try { fetchController?.abort(); } catch {}
      fetchController = new AbortController();

      setOverlay('Loading live scores‚Ä¶', scrollBox.childElementCount === 0);

      try {
        const timeoutId = setTimeout(() => fetchController.abort(), 10_000);
        const res = await fetch(API, { signal: fetchController.signal, cache: 'no-store' });
        clearTimeout(timeoutId);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const matches = Array.isArray(data?.livescore) ? data.livescore : [];

        if (!matches.length) {
          scrollBox.replaceChildren();
          const empty = document.createElement('div');
          empty.textContent = 'No live scores right now.';
          scrollBox.appendChild(empty);
        } else {
          renderMatches(matches);
        }

        setOverlay('', false);
        setStatus(`Updated ${formatTime(new Date())}`);
        startScroll();

      } catch (err) {
        if (scrollBox.childElementCount === 0) {
          setOverlay('Error loading scores. Retrying‚Ä¶', true);
        }
        setStatus(`Last attempt failed @ ${formatTime(new Date())}`);
        console.error('Fetch error:', err);
      }
    }

    try {
      const m = window.matchMedia('(prefers-reduced-motion: reduce)');
      m.addEventListener('change', (e) => {
        prefersReducedMotion = e.matches;
        startScroll();
      });
    } catch {}

    loadScores();
    intervalId = setInterval(loadScores, REFRESH_MS);

    window.addEventListener('beforeunload', () => {
      clearInterval(intervalId);
      cancelScroll();
      try { fetchController?.abort(); } catch {}
      io.disconnect();
    });
  </script>
</body>
