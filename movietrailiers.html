<style>
  #tmdb-widget {
    display: flex;
    width: 100%;
    height: 100%;
    background: black;
    color: white;
    overflow: hidden;
    font-family: Arial, sans-serif;
  }
  #poster-container {
    flex: 2;
    display: flex;
    justify-content: center;
    align-items: center;
    background: black;
  }
  #poster {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    cursor: pointer;
    border-radius: 8px;
  }
  #trailer-container {
    flex: 1;
    background: black;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
  }
  #player {
    width: 100%;
    height: 80%;
    border-radius: 8px;
  }
  #movie-title {
    margin-top: 8px;
    font-weight: bold;
    text-align: center;
  }
  #controls {
    margin-top: 10px;
    display: flex;
    gap: 10px;
  }
  button {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover {
    background: rgba(255,255,255,0.4);
  }
</style>

<div id="tmdb-widget">
  <div id="poster-container">
    <img id="poster" src="" alt="Movie Poster" title="Click to replay trailer" />
  </div>
  <div id="trailer-container">
    <div id="player"></div>
    <div id="movie-title"></div>
    <div id="controls">
      <button id="skip-poster">Next Poster</button>
      <button id="skip-trailer">Next Trailer</button>
    </div>
  </div>
</div>

<script>
  const apiKey = "535604d76e21128c384586e1502d1609";
  let movies = [];
  let postersIndex = 0;
  let trailersIndex = 0;
  let posterInterval;
  let player;

  // Load YouTube iframe API
  let tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  async function fetchTrailers(movieId) {
    const res = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${apiKey}`);
    const data = await res.json();
    return data.results.filter(video => video.type === "Trailer" && video.site === "YouTube");
  }

  async function fetchAllUpcomingMoviesRandomPages(pagesCount = 10, maxPage = 50) {
    let pages = Array.from({length: maxPage}, (_, i) => i + 1);
    pages = shuffleArray(pages).slice(0, pagesCount);
    for (let page of pages) {
      const res = await fetch(`https://api.themoviedb.org/3/movie/upcoming?api_key=${apiKey}&language=en-US&page=${page}`);
      const data = await res.json();
      movies = movies.concat(data.results);
    }
    for (let movie of movies) {
      movie.trailers = await fetchTrailers(movie.id);
    }
  }

  fetchAllUpcomingMoviesRandomPages().then(() => {
    if (movies.length > 0) {
      showPoster();
      posterInterval = setInterval(nextPoster, 60000);
    } else {
      console.error("No upcoming movies found");
    }
  }).catch(() => {
    console.error("Failed to load upcoming movies");
  });

  function showPoster() {
    const movie = movies[postersIndex];
    const posterImg = document.getElementById('poster');
    posterImg.src = `https://image.tmdb.org/t/p/w780${movie.poster_path}`;
    posterImg.title = movie.title;
    updateTrailerInfo();
  }

  function nextPoster() {
    postersIndex = Math.floor(Math.random() * movies.length);
    trailersIndex = 0;
    showPoster();
  }

  function updateTrailerInfo() {
    const movie = movies[postersIndex];
    const titleElem = document.getElementById('movie-title');
    titleElem.textContent = movie.title;
    if (player) {
      if(movie.trailers && movie.trailers.length > 0) {
        trailersIndex = trailersIndex % movie.trailers.length;
        player.loadVideoById(movie.trailers[trailersIndex].key);
      } else {
        player.stopVideo();
        titleElem.textContent += " (No trailer)";
      }
    }
  }

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      width: '100%',
      height: '100%',
      videoId: '',
      playerVars: { autoplay: 1, controls: 1, mute: 1, modestbranding: 1 },
      events: {
        onReady: event => {
          updateTrailerInfo();
          event.target.playVideo();
        },
        onStateChange: event => {
          if (event.data === YT.PlayerState.ENDED) {
            nextTrailer();
          }
        }
      }
    });
  }

  function nextTrailer() {
    const movie = movies[postersIndex];
    if (!movie.trailers || movie.trailers.length === 0) return;
    trailersIndex = (trailersIndex + 1) % movie.trailers.length;
    updateTrailerInfo();
    if (player) {
      player.playVideo();
    }
  }

  // Controls handlers
  document.getElementById('poster').addEventListener('click', () => {
    updateTrailerInfo();
    if (player) player.playVideo();
  });

  document.getElementById('skip-poster').addEventListener('click', () => {
    clearInterval(posterInterval);
    nextPoster();
    posterInterval = setInterval(nextPoster, 60000);
  });

  document.getElementById('skip-trailer').addEventListener('click', () => {
    nextTrailer();
  });
</script>
